apiVersion: 1

groups:
  - name: HeapUsed
    folder: stackbill-Alert
    interval: 1m
    rules:
      - uid: heapused-high # Make sure this is unique across all rules
        title: Heap Used High
        condition: A
        noDataState: Ok
        execErrState: Error
        for: 2m # 2 minutes above threshold triggers alert
        data:
          - refId: A
            queryType: timeSeriesQuery
            datasourceUid: cervux20smhvke
            relativeTimeRange: { from: 120, to: 0 }
            model:
              expr: |
                (
                  sum by (id,instance) (jvm_memory_used_bytes{area="heap",instance=~"sb-core.*|sb-billing.*"})
                  /
                  sum by (id, instance) (jvm_memory_max_bytes{area="heap",instance=~"sb-core.*|sb-billing.*"} unless jvm_memory_max_bytes{area="heap",instance=~"sb-core.*|sb-billing.*"} == -1)
                ) * 100 > 90
              instant: true
              interval: ""
              # datasource: { type: prometheus, uid: cervux20smhvke }
              refId: A
        annotations:
          # summary: |
          #   {{ template "HeapUsedHigh" . }}
          description: |
            Heap usage above 90% for the past 2 minutes. Possible errors: java.lang.OutOfMemoryError: Java heap space.
        labels:
          alertname: HeapUsedHigh
          severity: critical
          component: java
          grafana_folder: stackbill-Alert
